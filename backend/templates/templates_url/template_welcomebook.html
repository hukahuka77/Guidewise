{% extends "base_guidebook.html" %}
{% import "_macros.html" as m %}

{% block head_extra %}
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root {
    --bg-cream: #F5F1ED;
    --bg-white: #FFFFFF;
    --text-dark: #1A1A1A;
    --text-gray: #6B6B6B;
    --border-light: #E5E1DC;
    --accent-warm: #D4A574;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  /* Override base template layout so page scrolls normally (no inner scroll box) */
  body>div.flex {
    min-height: 0 !important;
    align-items: stretch !important;
    overflow: visible !important;
  }

  body>div.flex>div.flex {
    background: var(--bg-cream) !important;
    width: 100% !important;
    max-width: none !important;
    height: auto !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    overflow: visible !important;
  }

  /* Hide the sidebar completely */
  aside {
    display: none !important;
  }

  /* Make main area full width with cream background and normal page scrolling */
  main {
    background: var(--bg-cream) !important;
    max-width: 100% !important;
    padding: 0 !important;
    overflow: visible !important;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-cream);
    color: var(--text-dark);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
    overflow-y: auto;
  }

  /* Ensure content wrapper doesn't interfere with sticky */
  #content,
  [id*="content"] {
    overflow: visible !important;
  }

  /* Header */
  .header {
    text-align: center;
    padding: 3rem 1.5rem 2rem;
    background: var(--bg-cream);
  }

  .header-title {
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 800;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .header-subtitle {
    font-size: clamp(0.9rem, 2vw, 1.1rem);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-gray);
    font-weight: 500;
  }

  /* Sticky Navigation */
  .nav-bar {
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid var(--border-light);
    border-top: 2px solid var(--border-light);
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    overflow: hidden;
  }

  .nav-bar.collapsed {
    background: rgba(255, 255, 255, 0.98);
  }

  .nav-container {
    width: 100%;
    padding: 0.75rem 2rem;
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    scrollbar-width: none;
    justify-content: center;
    flex-wrap: wrap;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 200px;
    opacity: 1;
    transform: translateY(0);
  }

  /* Hide navbar items when collapsed */
  .nav-bar.collapsed .nav-container {
    max-height: 0;
    opacity: 0;
    padding-top: 0;
    padding-bottom: 0;
    transform: translateY(-10px);
  }

  .nav-container::-webkit-scrollbar {
    display: none;
  }

  .nav-toggle {
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    padding: 0.35rem;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 0;
    opacity: 0;
    transform: translateY(-10px);
  }

  /* Show down arrow ONLY when collapsed */
  .nav-bar.collapsed .nav-toggle {
    max-height: 32px;
    opacity: 1;
    transform: translateY(0);
  }

  .toggle-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--text-gray);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: var(--text-gray);
    border-radius: 8px;
    transition: all 0.2s;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
    min-width: 80px;
    max-width: 80px;
    text-align: center;
  }

  .nav-link:hover {
    background: var(--bg-cream);
    color: var(--text-dark);
  }

  .nav-icon {
    width: 1.25rem;
    height: 1.25rem;
    stroke-width: 2;
  }

  /* Section Card */
  .section-card {
    background: var(--bg-white);
    border-radius: 20px;
    padding: 2.5rem 2rem;
    margin: 0 2rem 2rem 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .section-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-icon {
    width: 1.75rem;
    height: 1.75rem;
    color: var(--accent-warm);
    stroke-width: 2;
  }

  .section-content p {
    margin-bottom: 1rem;
    color: var(--text-gray);
    line-height: 1.8;
  }

  .section-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-gray);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .section-value {
    font-size: 1.1rem;
    color: var(--text-dark);
    margin-bottom: 1.5rem;
    font-weight: 500;
  }

  /* Host Card */
  .host-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1.5rem;
    background: var(--bg-cream);
    border-radius: 16px;
    margin-top: 1.5rem;
  }

  .host-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--bg-white);
  }

  .host-info h4 {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
    color: var(--text-dark);
  }

  .host-info p {
    color: var(--text-gray);
    font-size: 0.95rem;
  }

  /* List Items */
  .info-list {
    list-style: none;
    padding: 0;
  }

  .info-item {
    display: flex;
    align-items: flex-start;
    padding: 1rem;
    background: var(--bg-cream);
    border-radius: 12px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: background 0.3s ease;
    position: relative;
  }

  .info-item:hover {
    background: #EBE7E2;
  }

  .info-item-icon {
    width: 1.5rem;
    height: 1.5rem;
    margin-right: 1rem;
    flex-shrink: 0;
    color: var(--accent-warm);
    stroke-width: 2;
  }

  .info-item-content {
    flex: 1;
  }

  .info-item-content h5 {
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .expandable-content {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-10px);
    transition: max-height 0.25s ease-out,
      opacity 0.2s ease-out,
      transform 0.25s ease-out;
  }

  .info-item.expanded .expandable-content {
    max-height: 2000px;
    opacity: 1;
    transform: translateY(0);
    padding-top: 0.5rem;
  }

  .expandable-content p {
    color: var(--text-gray);
    font-size: 0.95rem;
    margin: 0 0 0.5rem 0;
  }

  .media-container {
    margin-top: 0.75rem;
    display: flex;
    justify-content: flex-start;
  }

  .chevron-icon {
    width: 1rem;
    height: 1rem;
    color: var(--text-gray);
    transition: transform 0.2s ease-out;
    flex-shrink: 0;
  }

  .info-item.expanded .chevron-icon {
    transform: rotate(180deg);
  }

  /* Rules List */
  .rules-list {
    list-style: none;
    padding: 0;
  }

  .rules-list li {
    padding: 1rem;
    background: var(--bg-cream);
    border-radius: 12px;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .rules-list li::before {
    content: "â€¢";
    color: var(--accent-warm);
    font-size: 1.5rem;
    font-weight: bold;
    flex-shrink: 0;
  }

  /* Places Grid */
  .places-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  .place-card {
    background: var(--bg-cream);
    border-radius: 12px;
    padding: 0;
    overflow: hidden;
  }

  .place-card-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
  }

  .place-card-content {
    padding: 1.5rem;
  }

  .place-card h5 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .place-card p {
    color: var(--text-gray);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .place-card .place-address {
    font-size: 0.85rem;
    color: var(--text-gray);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .place-address-icon {
    width: 1rem;
    height: 1rem;
    color: var(--accent-warm);
    stroke-width: 2;
    flex-shrink: 0;
  }

  /* Cover Image */
  .cover-image {
    width: calc(100% - 4rem);
    height: 300px;
    object-fit: cover;
    border-radius: 20px;
    margin: 0 2rem 2rem 2rem;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .header {
      padding: 2rem 1rem 1.5rem;
    }

    .header-title {
      font-size: 2rem;
    }

    .section-card {
      padding: 1.5rem 1.25rem;
      margin: 0 1rem 1.5rem 1rem;
    }

    .cover-image {
      width: calc(100% - 2rem);
      margin: 0 1rem 1.5rem 1rem;
    }

    .places-grid {
      grid-template-columns: 1fr;
    }

    .host-card {
      flex-direction: column;
      text-align: center;
    }

    .nav-container {
      justify-content: center;
      padding: 0.5rem 0.5rem;
      gap: 0.25rem;
    }

    .nav-link {
      font-size: 0.65rem;
      padding: 0.5rem 0.4rem;
      min-width: 60px;
      max-width: 60px;
      gap: 0.15rem;
      border: 1px solid var(--border-light);
    }

    .nav-link span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    .nav-icon {
      width: 1rem;
      height: 1rem;
    }

    .nav-container {
      max-height: 140px;
    }

    .nav-bar.collapsed .nav-container {
      max-height: 0;
    }
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Scroll offset for sticky nav */
  section[id],
  div[id] {
    scroll-margin-top: 100px;
  }
</style>
{% endblock %}

{% block sidebar %}{% endblock %}

{% block content %}
<!-- Header -->
<div class="header">
  <h1 class="header-title">Welcome Book</h1>
  <p class="header-subtitle">Short Term Rental Guide</p>
</div>

<!-- Sticky Navigation -->
<nav class="nav-bar" id="navbar">
  <div class="nav-container">
    {% if 'welcome' in ctx.included_tabs %}
    <a href="#welcome" class="nav-link">
      <i data-lucide="home" class="nav-icon"></i>
      <span>Welcome</span>
    </a>
    {% endif %}
    {% if 'checkin' in ctx.included_tabs %}
    <a href="#checkin" class="nav-link">
      <i data-lucide="key" class="nav-icon"></i>
      <span>Check-in</span>
    </a>
    {% endif %}
    {% if ctx.wifi_json and (ctx.wifi_json.network or ctx.wifi_json.password) %}
    <a href="#wifi" class="nav-link">
      <i data-lucide="wifi" class="nav-icon"></i>
      <span>Wi-Fi</span>
    </a>
    {% endif %}
    {% if 'property' in ctx.included_tabs and ctx.house_manual %}
    <a href="#property" class="nav-link">
      <i data-lucide="book-open" class="nav-icon"></i>
      <span>House Guide</span>
    </a>
    {% endif %}
    {% if 'rules' in ctx.included_tabs and ctx.rules %}
    <a href="#rules" class="nav-link">
      <i data-lucide="clipboard-list" class="nav-icon"></i>
      <span>Rules</span>
    </a>
    {% endif %}
    {% if 'food' in ctx.included_tabs and ctx.places_to_eat %}
    <a href="#food" class="nav-link">
      <i data-lucide="utensils" class="nav-icon"></i>
      <span>Dining</span>
    </a>
    {% endif %}
    {% if 'activities' in ctx.included_tabs and ctx.things_to_do %}
    <a href="#activities" class="nav-link">
      <i data-lucide="compass" class="nav-icon"></i>
      <span>Activities</span>
    </a>
    {% endif %}
    {% if 'checkout' in ctx.included_tabs %}
    <a href="#checkout" class="nav-link">
      <i data-lucide="luggage" class="nav-icon"></i>
      <span>Checkout</span>
    </a>
    {% endif %}
    {% for tab_key in ctx.included_tabs %}
    {% if tab_key.startswith('custom_') and ctx.custom_sections.get(tab_key) %}
    {% set meta = ctx.custom_tabs_meta.get(tab_key) if ctx.custom_tabs_meta else None %}
    <a href="#{{ tab_key }}" class="nav-link">
      <i data-lucide="puzzle" class="nav-icon"></i>
      <span>{{ (meta.label if meta and meta.label) or (tab_key | replace('custom_', '') | replace('_', ' ') | title)
        }}</span>
    </a>
    {% endif %}
    {% endfor %}
  </div>
  <div class="nav-toggle" id="navToggle">
    <i data-lucide="chevron-down" class="toggle-icon"></i>
  </div>
</nav>

<div style="max-width: none; width: 100%; padding: 0; margin: 0;">
  <!-- Cover Image -->
  {% if ctx.cover_image_url %}
  <img src="{{ ctx.cover_image_url }}" alt="Property" class="cover-image" />
  {% endif %}

  <!-- Welcome Section -->
  {% if 'welcome' in ctx.included_tabs %}
  <div id="welcome" class="section-card">
    <h2 class="section-title">
      <i data-lucide="home" class="section-icon"></i>
      Welcome
    </h2>
    <div class="section-content">
      {% if ctx.welcome_message %}
      <p>{{ ctx.welcome_message }}</p>
      {% endif %}

      {% if ctx.address.street or ctx.address.city_state %}
      <div style="margin-top: 1.5rem;">
        <div class="section-label">Property Location</div>
        <div class="section-value">
          <a href="https://maps.google.com/maps?q={{ (ctx.address.street ~ ', ' ~ ctx.address.city_state ~ ' ' ~ (ctx.address.zip or '')) | urlencode }}"
            target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">
            {{ ctx.address.street }}{% if ctx.address.city_state %}, {{ ctx.address.city_state }}{% endif %}{% if
            ctx.address.zip %} {{ ctx.address.zip }}{% endif %}
          </a>
        </div>
      </div>
      {% endif %}

      {% if ctx.safety_info and (ctx.safety_info.emergency_contact or ctx.safety_info.fire_extinguisher_location) %}
      <ul class="info-list" style="margin-top: 1.5rem;">
        {% if ctx.safety_info.emergency_contact %}
        <li class="info-item">
          <i data-lucide="phone" class="info-item-icon"></i>
          <div class="info-item-content">
            <h5>Emergency Contact</h5>
            <p>{{ ctx.safety_info.emergency_contact }}</p>
          </div>
        </li>
        {% endif %}
        {% if ctx.safety_info.fire_extinguisher_location %}
        <li class="info-item">
          <i data-lucide="flame" class="info-item-icon"></i>
          <div class="info-item-content">
            <h5>Fire Extinguisher</h5>
            <p>{{ ctx.safety_info.fire_extinguisher_location }}</p>
          </div>
        </li>
        {% endif %}
      </ul>
      {% endif %}

      {% if ctx.host and (ctx.host.name or ctx.host.photo_url) %}
      <div class="host-card">
        {% if ctx.host.photo_url %}
        <img src="{{ ctx.host.photo_url }}" alt="{{ ctx.host.name or 'Host' }}" class="host-photo" />
        {% endif %}
        <div class="host-info">
          {% if ctx.host.name %}
          <h4>{{ ctx.host.name }}</h4>
          {% endif %}
          {% if ctx.host.bio %}
          <p>{{ ctx.host.bio }}</p>
          {% endif %}
          {% if ctx.host.contact %}
          <p style="white-space: pre-line;">{{ ctx.host.contact }}</p>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Check-in Section -->
  {% if 'checkin' in ctx.included_tabs %}
  <div id="checkin" class="section-card">
    <h2 class="section-title">
      <i data-lucide="key" class="section-icon"></i>
      Check-in Info
    </h2>
    <div class="section-content">
      {% if ctx.check_in_time %}
      <div class="section-label">Check-in Time</div>
      <div class="section-value">{{ ctx.check_in_time }}</div>
      {% endif %}

      {% if ctx.access_info %}
      <div class="section-label">Access Instructions</div>
      <div class="section-value" style="white-space: pre-line;">{{ ctx.access_info }}</div>
      {% endif %}

      {% if ctx.parking_info %}
      <div class="section-label">Parking</div>
      <div class="section-value" style="white-space: pre-line;">{{ ctx.parking_info }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Wi-Fi -->
  {% if ctx.wifi_json and (ctx.wifi_json.network or ctx.wifi_json.password) %}
  <div id="wifi" class="section-card">
    <h2 class="section-title">
      <i data-lucide="wifi" class="section-icon"></i>
      Wi-Fi
    </h2>
    <div class="section-content">
      {% if ctx.wifi_json.network %}
      <div style="margin-bottom: 1rem;">
        <div class="section-label">Network Name</div>
        <div class="section-value">{{ ctx.wifi_json.network }}</div>
      </div>
      {% endif %}
      {% if ctx.wifi_json.password %}
      <div>
        <div class="section-label">Password</div>
        <div class="section-value">{{ ctx.wifi_json.password }}</div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- House Manual -->
  {% if 'property' in ctx.included_tabs and ctx.house_manual %}
  <div id="property" class="section-card">
    <h2 class="section-title">
      <i data-lucide="book-open" class="section-icon"></i>
      House Guide
    </h2>
    <ul class="info-list">
      {% for item in ctx.house_manual %}
      <li class="info-item" onclick="this.classList.toggle('expanded')">
        <i data-lucide="info" class="info-item-icon"></i>
        <div class="info-item-content">
          <h5>
            {{ item.name }}
            <i data-lucide="chevron-down" class="chevron-icon"></i>
          </h5>
          <div class="expandable-content">
            {% if item.description %}
            <p>{{ item.description }}</p>
            {% endif %}
            {% if item.media_type and item.media_url %}
            <div class="media-container">
              {% if item.media_type == 'image' %}
              <img src="{{ item.media_url }}" alt="{{ item.name }}"
                style="max-width: 320px; max-height: 260px; height: auto; object-fit: contain; border-radius: 10px; display: block;" />
              {% elif item.media_type == 'video' %}
              <video controls style="width: 100%; max-height: 260px; border-radius: 10px;">
                <source src="{{ item.media_url }}" type="video/mp4" />
                Your browser does not support the video tag.
              </video>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- House Rules -->
  {% if 'rules' in ctx.included_tabs and ctx.rules %}
  <div id="rules" class="section-card">
    <h2 class="section-title">
      <i data-lucide="clipboard-list" class="section-icon"></i>
      House Rules
    </h2>
    <ul class="info-list">
      {% for rule in ctx.rules %}
      <li class="info-item" onclick="this.classList.toggle('expanded')">
        <i data-lucide="shield-check" class="info-item-icon"></i>
        <div class="info-item-content">
          <h5>
            {{ rule.name }}
            {% if rule.description %}
            <i data-lucide="chevron-down" class="chevron-icon"></i>
            {% endif %}
          </h5>
          {% if rule.description %}
          <p>{{ rule.description }}</p>
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Places to Eat -->
  {% if 'food' in ctx.included_tabs and ctx.places_to_eat %}
  <div id="food" class="section-card">
    <h2 class="section-title">
      <i data-lucide="utensils" class="section-icon"></i>
      Places to Eat
    </h2>
    <div class="places-grid">
      {% for place in ctx.places_to_eat %}
      <div class="place-card">
        {% if place.image_url %}
        <img src="/api/place-photo?photo_reference={{ place.image_url | urlencode }}&maxwidth=800"
          alt="{{ place.name }}" class="place-card-image" />
        {% endif %}
        <div class="place-card-content">
          <h5>{{ place.name }}</h5>
          {% if place.description %}
          <p>{{ place.description }}</p>
          {% endif %}
          {% if place.address %}
          <a href="https://maps.google.com/maps?q={{ place.address | urlencode }}" target="_blank"
            rel="noopener noreferrer" class="place-address" style="text-decoration: none; color: inherit;">
            <i data-lucide="map-pin" class="place-address-icon"></i>
            <span>{{ place.address }}</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Activities -->
  {% if 'activities' in ctx.included_tabs and ctx.things_to_do %}
  <div id="activities" class="section-card">
    <h2 class="section-title">
      <i data-lucide="compass" class="section-icon"></i>
      Things to Do
    </h2>
    <div class="places-grid">
      {% for activity in ctx.things_to_do %}
      <div class="place-card">
        {% if activity.image_url %}
        <img src="/api/place-photo?photo_reference={{ activity.image_url | urlencode }}&maxwidth=800"
          alt="{{ activity.name }}" class="place-card-image" />
        {% endif %}
        <div class="place-card-content">
          <h5>{{ activity.name }}</h5>
          {% if activity.description %}
          <p>{{ activity.description }}</p>
          {% endif %}
          {% if activity.address %}
          <a href="https://maps.google.com/maps?q={{ activity.address | urlencode }}" target="_blank"
            rel="noopener noreferrer" class="place-address" style="text-decoration: none; color: inherit;">
            <i data-lucide="map-pin" class="place-address-icon"></i>
            <span>{{ activity.address }}</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Checkout -->
  {% if 'checkout' in ctx.included_tabs %}
  <div id="checkout" class="section-card">
    <h2 class="section-title">
      <i data-lucide="luggage" class="section-icon"></i>
      Before You Go
    </h2>
    <div class="section-content">
      {% if ctx.check_out_time %}
      <div class="section-label">Checkout Time</div>
      <div class="section-value">{{ ctx.check_out_time }}</div>
      {% endif %}

      {% if ctx.checkout_info %}
      <ul class="info-list">
        {% for item in ctx.checkout_info %}
        <li class="info-item" onclick="this.classList.toggle('expanded')">
          <i data-lucide="check-circle" class="info-item-icon"></i>
          <div class="info-item-content">
            <h5>
              {{ item.name }}
              <i data-lucide="chevron-down" class="chevron-icon"></i>
            </h5>
            {% if item.description %}
            <p>{{ item.description }}</p>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Custom Sections -->
  {% if ctx.custom_sections %}
  {% for tab_key in ctx.included_tabs %}
  {% if tab_key.startswith('custom_') and ctx.custom_sections.get(tab_key) %}
  {% set section_blocks = ctx.custom_sections[tab_key] %}
  {% set meta = ctx.custom_tabs_meta.get(tab_key) if ctx.custom_tabs_meta else None %}
  <div id="{{ tab_key }}" class="section-card">
    <h2 class="section-title">
      <i data-lucide="puzzle" class="section-icon"></i>
      {{ (meta.label if meta and meta.label) or (tab_key | replace('custom_', '') | replace('_', ' ') | title) }}
    </h2>
    <div class="section-content">
      {% if section_blocks %}
      {% for block in section_blocks %}
      <p style="white-space: pre-line; margin-bottom: 1rem;">{{ block }}</p>
      {% endfor %}
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}
</div>
{% endblock %}

{% block body_scripts %}
<script>
  // Initialize Lucide icons when the page loads
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // Navbar collapse/expand functionality
    const navbar = document.getElementById('navbar');
    const navToggle = document.getElementById('navToggle');
    let lastScrollTop = 0;
    let navbarOriginalTop = null;
    let isManuallyExpanded = false;
    let ticking = false;
    const scrollThreshold = 20; // Minimum pixels to scroll before triggering change

    // Get the navbar's original position
    function getNavbarOriginalPosition() {
      if (navbarOriginalTop === null) {
        const header = document.querySelector('.header');
        if (header) {
          navbarOriginalTop = header.offsetHeight;
        }
      }
      return navbarOriginalTop || 0;
    }

    // Handle scroll
    function handleScroll() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const navOriginalPos = getNavbarOriginalPosition();
      const scrollDelta = Math.abs(scrollTop - lastScrollTop);

      // Ignore micro-movements to prevent jitter
      if (scrollDelta < scrollThreshold) {
        return;
      }

      // If user manually expanded, don't auto-collapse until they scroll up significantly
      if (isManuallyExpanded && scrollTop > lastScrollTop) {
        lastScrollTop = scrollTop;
        return;
      }

      // Auto-expand when near the top (within 30px of original position)
      if (scrollTop <= navOriginalPos + 30) {
        navbar.classList.remove('collapsed');
        isManuallyExpanded = false;
      }
      // Collapse immediately when scrolling down past the navbar's original position
      else if (scrollTop > lastScrollTop && scrollTop > navOriginalPos + 10) {
        navbar.classList.add('collapsed');
        isManuallyExpanded = false;
      }
      // Expand when scrolling up
      else if (scrollTop < lastScrollTop && scrollTop > navOriginalPos + 30) {
        navbar.classList.remove('collapsed');
        isManuallyExpanded = false;
      }

      lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }

    // Throttle scroll events for better performance
    window.addEventListener('scroll', function () {
      if (!ticking) {
        window.requestAnimationFrame(function () {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Manual toggle - only expand from collapsed state
    navToggle.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      if (navbar.classList.contains('collapsed')) {
        // User clicked down arrow - expand navbar
        navbar.classList.remove('collapsed');
        isManuallyExpanded = true;
      }
    });

    // Initialize - get original position after a short delay to ensure layout is settled
    setTimeout(getNavbarOriginalPosition, 100);
  });
</script>
{% endblock %}